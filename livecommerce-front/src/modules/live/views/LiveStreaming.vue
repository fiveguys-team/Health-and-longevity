<!--<script setup>-->
<!--import { onMounted } from 'vue';-->


<!--import NavbarOne from '@/components/navbar/navbar-one.vue';-->
<!--// import FooterOne from '@/components/footer/footer-one.vue';-->
<!--// import FooterThree from '@/components/footer/footer-three.vue';-->
<!--import ScrollToTop from '@/components/scroll-to-top.vue';-->

<!--import 'swiper/swiper-bundle.css';-->

<!--import LiveScreen from '@/modules/live/components/LiveScreen.vue';-->

<!--import Aos from 'aos';-->
<!--import 'aos/dist/aos.css';-->

<!--onMounted(() => {-->
<!--  Aos.init()-->
<!--});-->
<!--</script>-->

<!--<template>-->
<!--  <div>-->
<!--    <NavbarOne />-->

<!--    <div class="live-container">-->
<!--      &lt;!&ndash; ìƒë‹¨: ë°©ì†¡ ì œëª© & ë©”íƒ€ì •ë³´ &ndash;&gt;-->
<!--      <div class="header-bar">-->
<!--        <div class="title-cell">ë°©ì†¡ ì œëª©</div>-->
<!--        <div class="meta-cell">ì°¸ì—¬ì ìˆ˜</div>-->
<!--        <div class="meta-cell">ë°©ì†¡ ê²½ê³¼ ì‹œê°„</div>-->
<!--        <div class="meta-cell">ë°©ì†¡ ì¢…ë£Œ ì‹œê°„</div>-->
<!--      </div>-->

<!--      &lt;!&ndash; ë³¸ë¬¸ ì˜ì—­: ì™¼ìª½(ì˜ìƒ + ìƒí’ˆ) / ì˜¤ë¥¸ìª½(ê³µì§€ ë° ì±„íŒ…) &ndash;&gt;-->
<!--      <div class="main-content">-->
<!--        &lt;!&ndash; ì™¼ìª½ ì˜ì—­ &ndash;&gt;-->
<!--        <div class="left-area">-->
<!--          &lt;!&ndash; ë¼ì´ë¸Œ ì˜ìƒ í™”ë©´ &ndash;&gt;-->
<!--          <div class="video-wrapper">-->
<!--            <LiveScreen />-->
<!--            &lt;!&ndash; <div class="video-header">ğŸ“º [ë¼ì´ë¸Œ ì˜ìƒ í™”ë©´ (OpenVidu)]</div> &ndash;&gt;-->
<!--          </div>-->
<!--          &lt;!&ndash; ìƒí’ˆ ëª©ë¡ &ndash;&gt;-->
<!--          <div class="product-list">-->
<!--            <div class="product-card">-->
<!--              <div class="product-title">ìƒí’ˆ A</div>-->
<!--              <div class="product-thumb">ì‚¬ì§„</div>-->
<!--              <div class="product-info">ì œí’ˆëª…, ê°€ê²©</div>-->
<!--            </div>-->
<!--            <div class="product-card">-->
<!--              <div class="product-title">ìƒí’ˆ B</div>-->
<!--              <div class="product-thumb">ì‚¬ì§„</div>-->
<!--              <div class="product-info">ì œí’ˆëª…, ê°€ê²©</div>-->
<!--            </div>-->
<!--            <div class="product-card">-->
<!--              <div class="product-title">ìƒí’ˆ C</div>-->
<!--              <div class="product-thumb">ì‚¬ì§„</div>-->
<!--              <div class="product-info">ì œí’ˆëª…, ê°€ê²©</div>-->
<!--            </div>-->
<!--          </div>-->
<!--        </div>-->

<!--        &lt;!&ndash; ì˜¤ë¥¸ìª½ ì˜ì—­ ì±„íŒ… &ndash;&gt;-->
<!--        <div class="right-area">-->
<!--          &lt;!&ndash; ê³µì§€ & FAQ &ndash;&gt;-->
<!--          <div class="notice-box">-->
<!--            <div class="notice-header">-->
<!--              ğŸ“¢ ì˜¤ëŠ˜ ë°©ì†¡ ì¤‘ ë£¨í…Œì¸ 10% í• ì¸ + ì„ ì°©ìˆœ 50ëª… ë¬´ë£Œë°°ì†¡!-->
<!--            </div>-->
<!--            <ul class="faq-list">-->
<!--              <li>[ìœ ì €1] ë£¨í…Œì¸ ë³µìš© ë°©ë²•ì€ ì–´ë–»ê²Œ ë˜ë‚˜ìš”?</li>-->
<!--              <li>[ìœ ì €2] ë¬´ë£Œë°°ì†¡ ì´ë²¤íŠ¸ëŠ” ì–¸ì œê¹Œì§€ì¸ê°€ìš”?</li>-->
<!--              <li>[ìœ ì €3] ë¬´ë£Œë°°ì†¡ ì´ë²¤íŠ¸ëŠ” ì–¸ì œê¹Œì§€ì¸ê°€ìš”?</li>-->
<!--              <li>â€¦</li>-->
<!--            </ul>-->
<!--          </div>-->

<!--          &lt;!&ndash; ì±„íŒ… ì…ë ¥ì°½ &ndash;&gt;-->
<!--          <div class="chat-input-area">-->
<!--            <input type="text" class="chat-input" placeholder="[ì±„íŒ… ì…ë ¥ì°½]" />-->
<!--            <button class="send-button">SEND</button>-->
<!--          </div>-->
<!--        </div>-->
<!--      </div>-->
<!--    </div>-->

<!--    &lt;!&ndash; <FooterThree /> &ndash;&gt;-->

<!--    <ScrollToTop />-->

<!--  </div>-->
<!--</template>-->

<!--<style scoped>-->
<!--/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-->
<!--   ì „ì²´ ì»¨í…Œì´ë„ˆ-->
<!--â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */-->
<!--.live-container {-->
<!--  display: flex;-->
<!--  flex-direction: column;-->
<!--  border: 2px solid #444;    /* ì „ì²´ í…Œë‘ë¦¬ ìƒ‰ìƒ */-->
<!--  background-color: #f2f2f2; /* ì „ì²´ ë°°ê²½ */-->
<!--  font-family: "Noto Sans KR", sans-serif;-->
<!--  margin: 16px;-->
<!--  /* í•„ìš”í•œ ê²½ìš° max-width: 1200px; margin: 0 auto; ë“±ìœ¼ë¡œ ì¤‘ì•™ ì •ë ¬ ì¶”ê°€ ê°€ëŠ¥ */-->
<!--}-->

<!--/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-->
<!--   1. ìƒë‹¨: ë°©ì†¡ ì œëª© & ë©”íƒ€ì •ë³´-->
<!--â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */-->
<!--.header-bar {-->
<!--  display: grid;-->
<!--  grid-template-columns: 3fr 1fr 1fr 1fr; /* ì²« ì¹¸(ì œëª©)ì„ ë„“ê²Œ, ë‚˜ë¨¸ì§€ëŠ” ë™ì¼ í­ */-->
<!--  background-color: #fff;-->
<!--  border-bottom: 2px solid #444;-->
<!--  align-items: center;-->
<!--  height: 50px;      /* ìƒë‹¨ ë°” ë†’ì´ */-->
<!--}-->

<!--.header-bar .title-cell {-->
<!--  padding-left: 12px;-->
<!--  font-size: 1.2rem;-->
<!--  font-weight: bold;-->
<!--  border-right: 2px solid #444;-->
<!--}-->

<!--.header-bar .meta-cell {-->
<!--  text-align: center;-->
<!--  font-weight: 500;-->
<!--  border-right: 2px solid #444;-->
<!--}-->

<!--.header-bar .meta-cell:last-child {-->
<!--  border-right: none; /* ë§ˆì§€ë§‰ ì¹¸ í…Œë‘ë¦¬ ì œê±° */-->
<!--}-->

<!--/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€-->
<!--   2. ë³¸ë¬¸: ì™¼ìª½(ì˜ìƒ+ìƒí’ˆ) / ì˜¤ë¥¸ìª½(ê³µì§€+ì±„íŒ…)-->
<!--â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */-->
<!--.main-content {-->
<!--  display: flex;-->
<!--  flex-direction: row;-->
<!--  height: 800px;-->
<!--  /* ë†’ì´ë¥¼ ì§€ì •í•˜ì§€ ì•Šìœ¼ë©´ ì½˜í…ì¸ ì— ë”°ë¼ ëŠ˜ì–´ë‚¨ */-->
<!--}-->

<!--/* â”€ Left Area */-->
<!--.left-area {-->
<!--  flex: 3;-->
<!--  display: flex;-->
<!--  flex-direction: column;-->
<!--  padding: 12px;-->
<!--}-->

<!--/* 2-1. ë¼ì´ë¸Œ ì˜ìƒ í™”ë©´ */-->
<!--.video-wrapper {-->
<!--  flex: 1;-->
<!--  border: 2px solid #888;-->
<!--  background-color: #ddd;-->
<!--  display: flex;-->
<!--  align-items: center;-->
<!--  justify-content: center;-->
<!--  margin-bottom: 12px;-->
<!--}-->

<!--.video-header {-->
<!--  font-size: 1.1rem;-->
<!--  font-weight: 600;-->
<!--}-->

<!--/* 2-2. ìƒí’ˆ ëª©ë¡ */-->
<!--.product-list {-->
<!--  display: flex;-->
<!--  flex-direction: row;-->
<!--  justify-content: space-between;-->
<!--}-->

<!--.product-card {-->
<!--  flex: 1;-->
<!--  border: 2px solid #555;-->
<!--  background-color: #fafafa;-->
<!--  margin-right: 12px;-->
<!--  display: flex;-->
<!--  flex-direction: column;-->
<!--  align-items: center;-->
<!--  padding: 8px;-->
<!--}-->

<!--.product-card:last-child {-->
<!--  margin-right: 0;-->
<!--}-->

<!--.product-title {-->
<!--  font-size: 1.1rem;-->
<!--  font-weight: bold;-->
<!--  margin-bottom: 8px;-->
<!--}-->

<!--.product-thumb {-->
<!--  width: 100%;-->
<!--  height: 80px; /* ì¸ë„¤ì¼ ì˜ì—­ ë†’ì´ ì˜ˆì‹œ */-->
<!--  background-color: #e0e0e0;-->
<!--  display: flex;-->
<!--  align-items: center;-->
<!--  justify-content: center;-->
<!--  margin-bottom: 8px;-->
<!--}-->

<!--.product-info {-->
<!--  font-size: 0.95rem;-->
<!--  color: #333;-->
<!--}-->

<!--/* â”€ Right Area */-->
<!--.right-area {-->
<!--  flex: 1;-->
<!--  display: flex;-->
<!--  flex-direction: column;-->
<!--  padding: 12px;-->
<!--}-->

<!--/* 2-3. ê³µì§€ & FAQ ë°•ìŠ¤ */-->
<!--.notice-box {-->
<!--  flex: 1;-->
<!--  border: 2px solid #444;-->
<!--  border-radius: 8px;-->
<!--  background-color: #fff;-->
<!--  padding: 12px;-->
<!--  margin-bottom: 12px;-->
<!--  display: flex;-->
<!--  flex-direction: column;-->
<!--}-->

<!--.notice-header {-->
<!--  font-size: 1rem;-->
<!--  font-weight: bold;-->
<!--  margin-bottom: 8px;-->
<!--}-->

<!--.faq-list {-->
<!--  list-style: none;-->
<!--  padding-left: 0;-->
<!--  margin: 0;-->
<!--  font-size: 0.95rem;-->
<!--}-->

<!--.faq-list li {-->
<!--  margin-bottom: 6px;-->
<!--}-->

<!--/* 2-4. ì±„íŒ… ì…ë ¥ì°½ ë¶€ë¶„ */-->
<!--.chat-input-area {-->
<!--  display: flex;-->
<!--  flex-direction: row;-->
<!--  align-items: center;-->
<!--}-->

<!--.chat-input {-->
<!--  flex: 1;-->
<!--  height: 40px;-->
<!--  border: 2px solid #888;-->
<!--  border-radius: 4px;-->
<!--  padding: 0 8px;-->
<!--  font-size: 0.95rem;-->
<!--}-->

<!--.chat-input::placeholder {-->
<!--  color: #999;-->
<!--}-->

<!--.send-button {-->
<!--  width: 80px;-->
<!--  height: 40px;-->
<!--  margin-left: 8px;-->
<!--  background-color: #6dc066;-->
<!--  border: none;-->
<!--  border-radius: 4px;-->
<!--  color: #fff;-->
<!--  font-weight: bold;-->
<!--  cursor: pointer;-->
<!--}-->

<!--/* send ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */-->
<!--.send-button:hover {-->
<!--  background-color: #5bb354;-->
<!--}-->
<!--</style>-->

<!--
  LiveStreaming.vue
  ì†Œë¹„ììš© ë¼ì´ë¸Œ ìŠ¤íŠ¸ë¦¬ë° ì‹œì²­ ì»´í¬ë„ŒíŠ¸

  OpenVidu ì„¸ì…˜ì— ì°¸ì—¬í•˜ì—¬ í˜¸ìŠ¤íŠ¸ì˜ ìŠ¤íŠ¸ë¦¼ì„ êµ¬ë…í•˜ê³  í‘œì‹œ
  ë°©ì†¡ ì •ë³´, ìƒí’ˆ ì •ë³´ ë“±ì„ í•¨ê»˜ í‘œì‹œ

  ìŠ¤íŠ¸ë¦¼ êµ¬ë… ë° í‘œì‹œ
   - OpenVidu ì„¸ì…˜ ì°¸ì—¬
   - ì…ì ì—…ì²´ ìŠ¤íŠ¸ë¦¼ êµ¬ë…
   - UserVideo ì»´í¬ë„ŒíŠ¸ë¥¼ í†µí•œ ë¹„ë””ì˜¤ í‘œì‹œ

 ë°©ì†¡ ì •ë³´ í‘œì‹œ
    - ë°©ì†¡ ì œëª©
    - ìƒí’ˆ ì •ë³´ (ì´ë¦„, ê°€ê²©, ì„¤ëª…)
    - êµ¬ë§¤ ë²„íŠ¼

 [ìƒíƒœ ê´€ë¦¬]
 - OV: OpenVidu ì¸ìŠ¤í„´ìŠ¤
 - session: í˜„ì¬ ì—°ê²°ëœ ì„¸ì…˜
 - mainStreamManager: ë©”ì¸ ìŠ¤íŠ¸ë¦¼ ê´€ë¦¬ì -> subscriber
 - streamData: ë°©ì†¡/ìƒí’ˆ ì •ë³´
 - loadingMessage: ë¡œë”©/ì—ëŸ¬ ë©”ì‹œì§€

 [ì´ë²¤íŠ¸ í•¸ë“¤ë§]
 - streamCreated: ìƒˆ ìŠ¤íŠ¸ë¦¼ ìƒì„± ì‹œ
 - streamDestroyed: ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ ì‹œ
 - sessionDisconnected: ì„¸ì…˜ ì—°ê²° í•´ì œ ì‹œ
 - participantEvicted: ì°¸ê°€ì í‡´ì¥ ì‹œ

-->
<template>
  <div class="viewer-container">
    <!-- ìŠ¤íŠ¸ë¦¼ ì‹œì²­ ì˜ì—­: ì„¸ì…˜ê³¼ ìŠ¤íŠ¸ë¦¼ì´ ìˆì„ ë•Œë§Œ í‘œì‹œ -->
    <div class="stream-info" v-if="session && mainStreamManager">
      <!-- ë°©ì†¡ ì •ë³´ í—¤ë” -->
      <div class="stream-header">
        <h2>{{ streamData.title }}</h2>
        <!-- ìƒí’ˆ ì •ë³´ í‘œì‹œ ì˜ì—­ -->
        <div class="products-container">
          <div v-for="item in streamData.products" :key="item.id" class="product-card">
            <h3>{{ item.name }}</h3>
            <strong>{{ item.discountedPrice.toLocaleString() }}ì›</strong>
            <small class="text-muted">(ì •ê°€ {{ item.price.toLocaleString() }}ì›)</small>
            <button class="btn btn-primary">êµ¬ë§¤í•˜ê¸°</button>
          </div>
        </div>
      </div>
      <!-- ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ í‘œì‹œ ì˜ì—­ -->
      <div class="video-container">
        <div class="main-video">
          <user-video :stream-manager="mainStreamManager"/>


        </div>
      </div>
    </div>
    <!-- ë¡œë”©/ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
<!--    <div class="loading" v-else>-->
<!--      <p>{{ loadingMessage }}</p>-->
<!--    </div>-->
  </div>
</template>

<script setup>
import {onBeforeUnmount, onMounted, ref} from 'vue';
import {useRoute, useRouter} from 'vue-router';
import axios from 'axios';
import {OpenVidu} from 'openvidu-browser';
import UserVideo from '@/modules/live/components/UserVideo.vue';

// ë¼ìš°í„° ì„¤ì •
const route = useRoute();
const router = useRouter();
const APPLICATION_SERVER_URL = process.env.NODE_ENV === 'production' ? '' : 'http://localhost:8080/';

// OpenVidu ê´€ë ¨ ìƒíƒœ ê´€ë¦¬
const OV = ref(undefined);                 // OpenVidu ì¸ìŠ¤í„´ìŠ¤
const session = ref(undefined);            // í˜„ì¬ ì„¸ì…˜
const mainStreamManager = ref(undefined);  // ë©”ì¸ ìŠ¤íŠ¸ë¦¼ ê´€ë¦¬ì
const streamData = ref({});                // ë°©ì†¡/ìƒí’ˆ ì •ë³´
const loadingMessage = ref('ë°©ì†¡ì— ì—°ê²° ì¤‘ì…ë‹ˆë‹¤...'); // ìƒíƒœ ë©”ì‹œì§€

/**
 * ìƒˆë¡œìš´ ìŠ¤íŠ¸ë¦¼ ìƒì„± ì‹œ í˜¸ì¶œë˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
 * 1. ìŠ¤íŠ¸ë¦¼ì„ êµ¬ë…í•˜ê³  ë¹„ë””ì˜¤ í‘œì‹œ ì„¤ì •
 * 2. í˜¸ìŠ¤íŠ¸ ì •ë³´ ì €ì¥
 */
const handleStreamCreated = async ({stream}) => {
  try {
    // ìŠ¤íŠ¸ë¦¼ êµ¬ë… ì„¤ì •
    mainStreamManager.value = await session.value.subscribeAsync(stream, {
      insertMode: 'APPEND',
    });

    // í˜¸ìŠ¤íŠ¸ ì •ë³´ íŒŒì‹± ë° ì €ì¥
    const connectionData = JSON.parse(stream.connection.data || '{}');
    if (connectionData.clientData?.type === 'host') {
      streamData.value = connectionData.clientData;
    }
  } catch (error) {
    console.error('ìŠ¤íŠ¸ë¦¼ êµ¬ë… ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    loadingMessage.value = 'ìŠ¤íŠ¸ë¦¼ êµ¬ë… ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
  }
};

/**
 * ìŠ¤íŠ¸ë¦¼ ì¢…ë£Œ ì‹œ í˜¸ì¶œë˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
 * - ìŠ¤íŠ¸ë¦¼ ì •ë¦¬ ë° ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
 */
const handleStreamDestroyed = (event) => {
  console.log('Stream destroyed event:', event);
  if (mainStreamManager.value) {
    mainStreamManager.value = undefined;
    loadingMessage.value = 'ë°©ì†¡ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
    setTimeout(() => {
      router.push('/');
    }, 2000);
  }
};

/**
 * ì„¸ì…˜ ì—°ê²° í•´ì œ ì‹œ í˜¸ì¶œë˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
 * - ì„¸ì…˜ ì •ë¦¬ ë° ë©”ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
 */
const handleSessionDisconnected = (event) => {
  console.log('Session disconnected event:', event);
  cleanupSession();
  loadingMessage.value = 'ì„¸ì…˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
  setTimeout(() => {
    router.push('/');
  }, 2000);
};

/**
 * ì°¸ê°€ì í‡´ì¥ ì‹œ í˜¸ì¶œë˜ëŠ” ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
 * - í˜„ì¬ ì‚¬ìš©ìê°€ í‡´ì¥ëœ ê²½ìš° ì„¸ì…˜ ì •ë¦¬
 */
const handleParticipantEvicted = (event) => {
  console.log('Participant evicted event:', event);
  try {
    const currentConnectionId = session.value?.connection?.connectionId;
    const evictedConnectionId = event?.connection?.connectionId;

    if (currentConnectionId && evictedConnectionId && currentConnectionId === evictedConnectionId) {
      cleanupSession();
      loadingMessage.value = 'ë°©ì†¡ì—ì„œ í‡´ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.';
      setTimeout(() => {
        router.push('/');
      }, 2000);
    }
  } catch (error) {
    console.error('ì°¸ê°€ì í‡´ì¥ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    cleanupSession();
    router.push('/');
  }
};

/**
 * ì„¸ì…˜ í† í° ë°œê¸‰ í•¨ìˆ˜
 * - ë°±ì—”ë“œ ì„œë²„ì— í† í° ìš”ì²­
 * - ì—ëŸ¬ ì²˜ë¦¬ ë° ì ì ˆí•œ ë©”ì‹œì§€ ë°˜í™˜
 */
const getToken = async (sessionId) => {
  try {
    const response = await axios.post(
        `${APPLICATION_SERVER_URL}api/sessions/${sessionId}/connections`,
        {},
        {
          headers: {'Content-Type': 'application/json'},
          timeout: 5000 // 5ì´ˆ íƒ€ì„ì•„ì›ƒ ì„¤ì •
        }
    );
    return response.data;
  } catch (error) {
    console.error('í† í° ë°œê¸‰ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    if (error.code === 'ERR_NETWORK') {
      throw new Error('ì„œë²„ì— ì—°ê²°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
    }
    if (error.response?.status === 404) {
      throw new Error('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ë°©ì†¡ì…ë‹ˆë‹¤.');
    }
    throw new Error(error.message || 'í† í° ë°œê¸‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
  }
};

/**
 * ì„¸ì…˜ ì°¸ê°€ í•¨ìˆ˜
 * 1. OpenVidu ì„¸ì…˜ ì´ˆê¸°í™”
 * 2. ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
 * 3. í† í° ë°œê¸‰ ë° ì„¸ì…˜ ì—°ê²°
 */
const joinSession = async (sessionId) => {
  try {
    // ì´ì „ ì„¸ì…˜ ì •ë¦¬
    if (session.value) {
      cleanupSession();
    }

    // OpenVidu ì´ˆê¸°í™”
    OV.value = new OpenVidu();
    session.value = OV.value.initSession();

    // ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
    session.value.on('streamCreated', handleStreamCreated);
    session.value.on('streamDestroyed', handleStreamDestroyed);
    session.value.on('sessionDisconnected', handleSessionDisconnected);
    session.value.on('participantEvicted', handleParticipantEvicted);

    // ì—ëŸ¬ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
    session.value.on('error', (error) => {
      console.error('Session error:', error);
      loadingMessage.value = getErrorMessage(error);
      if (error.name === 'NETWORK_ERROR' || error.name === 'DISCONNECTED') {
        cleanupSession();
        router.push('/');
      }
    });

    // ì„¸ì…˜ ì—°ê²°
    const token = await getToken(sessionId);
    if (!token) {
      throw new Error('í† í°ì„ ë°›ì•„ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
    }

    await session.value.connect(token, {clientData: {type: 'viewer'}});

  } catch (error) {
    console.error('ì„¸ì…˜ ì°¸ê°€ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    loadingMessage.value = error.message || 'ë°©ì†¡ ì°¸ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    setTimeout(() => {
      router.push('/');
    }, 3000);
  }
};

/**
 * ì—ëŸ¬ ë©”ì‹œì§€ ìƒì„± í•¨ìˆ˜
 * - OpenVidu ì—ëŸ¬ íƒ€ì…ë³„ ì‚¬ìš©ì ì¹œí™”ì  ë©”ì‹œì§€ ë°˜í™˜
 */
const getErrorMessage = (error) => {
  switch (error.name) {
    case 'GENERIC_ERROR':
      return 'ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
    case 'NETWORK_ERROR':
      return 'ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
    case 'MEDIA_ACCESS_DENIED':
      return 'ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼ì´ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.';
    case 'DISCONNECTED':
      return 'ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
    case 'USER_NOT_FOUND':
      return 'ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
    default:
      return 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
  }
};

/**
 * ì„¸ì…˜ ì •ë¦¬ í•¨ìˆ˜
 * - ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
 * - ìŠ¤íŠ¸ë¦¼ êµ¬ë… í•´ì œ
 * - ì„¸ì…˜ ì—°ê²° í•´ì œ
 * - ìƒíƒœ ì´ˆê¸°í™”
 */
const cleanupSession = () => {
  try {
    if (session.value) {
      // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
      session.value.off('streamCreated');
      session.value.off('streamDestroyed');
      session.value.off('sessionDisconnected');
      session.value.off('participantEvicted');
      session.value.off('error');

      // ìŠ¤íŠ¸ë¦¼ êµ¬ë… í•´ì œ
      if (mainStreamManager.value) {
        session.value.unsubscribe(mainStreamManager.value);
        mainStreamManager.value = undefined;
      }

      // ì„¸ì…˜ ì—°ê²° í•´ì œ
      session.value.disconnect();
    }
  } catch (error) {
    console.error('ì„¸ì…˜ ì •ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
  } finally {
    // ìƒíƒœ ì´ˆê¸°í™”
    session.value = undefined;
    OV.value = undefined;
    streamData.value = {};
  }
};

// í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨/ì¢…ë£Œ ì‹œ ì •ë¦¬
window.addEventListener('beforeunload', () => {
  cleanupSession();
});

// ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ì„¸ì…˜ ì°¸ê°€
onMounted(async () => {
  try {
    const sessionId = route.params.sessionId;
    //const sessionId = session.value.sessionId;
    console.log("sessionId: " + sessionId);
    await joinSession(sessionId);
  } catch (error) {
    console.error('ë°©ì†¡ ì°¸ì—¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
    loadingMessage.value = 'ë°©ì†¡ ì°¸ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
    setTimeout(() => {
      router.push('/');
    }, 2000);
  }
});

// ì»´í¬ë„ŒíŠ¸ ì–¸ë§ˆìš´íŠ¸ ì‹œ ì •ë¦¬
onBeforeUnmount(() => {
  cleanupSession();
});
</script>

<style scoped>
/* ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
.viewer-container {
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
}

/* ë°©ì†¡ í—¤ë” ìŠ¤íƒ€ì¼ */
.stream-header {
  .stream-header {
    margin-bottom: 20px;
  }

  /* ìƒí’ˆ ì •ë³´ ìŠ¤íƒ€ì¼ */

  .products-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
  }

  /* ìƒí’ˆ ì¹´ë“œ ìŠ¤íƒ€ì¼ */

  .product-card {
    background-color: #f8f9fa;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s;
  }

  .product-card:hover {
    transform: translateY(-5px);
  }

  .product-card h3 {
    margin: 0 0 10px 0;
    color: #333;
    font-size: 1.2em;
  }

  .product-card .price {
    font-size: 1.3em;
    color: #dc3545;
    font-weight: bold;
    margin: 10px 0;
  }

  .product-card .description {
    color: #666;
    margin: 10px 0;
    font-size: 0.9em;
  }

  .product-card .btn {
    width: 100%;
    margin-top: 10px;
  }

  /* ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */

  .video-container {
    width: 100%;
    height: 0;
    padding-bottom: 56.25%; /* 16:9 ë¹„ìœ¨ */
    position: relative;
    background-color: #000;
    margin: 20px auto;
    overflow: hidden;
  }

  /* ë¹„ë””ì˜¤ ì»´í¬ë„ŒíŠ¸ ìŠ¤íƒ€ì¼ */

  .video-container :deep(.stream-component) {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  /* ë©”ì¸ ë¹„ë””ì˜¤ ìŠ¤íƒ€ì¼ */

  .main-video {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
  }

  /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */

  .btn {
    padding: 10px 20px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }

  .btn-primary {
    background-color: #007bff;
    color: white;
  }

  /* ë¡œë”© ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */

  .loading {
    text-align: center;
    padding: 50px;
    font-size: 1.2em;
    color: #666;
  }
}
</style>