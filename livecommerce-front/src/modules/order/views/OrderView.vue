<template>
  <div>
    <NavbarOne/>

    <div class="flex items-center gap-4 flex-wrap bg-overlay p-14 sm:p-16 before:bg-title before:bg-opacity-70"
         :style="{backgroundImage:'url(' + bg + ')'}">
      <div class="text-center w-full">
        <h2 class="text-white text-8 md:text-[40px] font-normal leading-none text-center">ê²°ì œí•˜ê¸°</h2>
        <ul class="flex items-center justify-center gap-[10px] text-base md:text-lg leading-none font-normal text-white mt-3 md:mt-4 flex-wrap">
          <li>
            <router-link to="/">í™ˆ</router-link>
          </li>
          <li>/</li>
          <li class="text-primary">ê²°ì œí•˜ê¸°</li>
        </ul>
      </div>
    </div>

    <div class="s-py-100">
      <div class="container">
        <div class="max-w-[1220px] mx-auto grid lg:grid-cols-2 gap-[30px] lg:gap-[70px]">
          <div
              class="bg-[#FAFAFA] dark:bg-dark-secondary p-[30px] md:p-[40px] lg:p-[50px] border border-[#17243026] border-opacity-15 rounded-xl"
              data-aos="fade-up">

            <!--            <p class="mb-5 w-full bg-white dark:bg-dark-secondary border border-[#E3E5E6] text-title dark:text-white focus:border-primary p-4 outline-none duration-300 whitespace-normal">-->
            <!--              ì¿ í° ì½”ë“œê°€ ìˆìœ¼ì‹ ê°€ìš”?-->
            <!--              <button @click="open = !open" class="ml-1 add-coupon-code underline text-[#209A60]">ì¶”ê°€í•˜ë ¤ë©´ í´ë¦­í•˜ì„¸ìš”</button>-->
            <!--            </p>-->

            <div v-if="open" class="coupon-wrapper gap-3 md:flex mb-[30px]">
              <input
                  class="max-w-[220px] w-full h-12 md:h-14 bg-white dark:bg-dark-secondary border border-[#E3E5E6] text-title dark:text-white focus:border-primary p-4 outline-none duration-300"
                  type="text"
                  placeholder="ì¿ í° ì½”ë“œ"
              />
              <router-link to="#" class="btn btn-sm-px btn-theme-solid" data-text="ì¿ í° ì ìš©">
                <span>ì¿ í° ì ìš©</span>
              </router-link>
            </div>

            <h4 class="font-semibold leading-none text-xl md:text-2xl mb-6 md:mb-[30px]">
              ë°°ì†¡ì§€ ì •ë³´
            </h4>
            <div class="grid gap-5 md:gap-6">
              <div>
                <label class="text-base md:text-lg text-title dark:text-white leading-none mb-2 sm:mb-3 block">ì´ë¦„</label>
                <input
                    ref="nameRef"
                    v-model="form.name"
                    class="w-full h-12 md:h-14 bg-white dark:bg-dark-secondary border border-[#E3E5E6] text-title dark:text-white focus:border-primary p-4 outline-none duration-300"
                    type="text"
                    placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"/>
                <p v-if="form.name && !isValidName" class="text-sm text-red-500 mt-1">
                  ì´ë¦„ì€ í•œê¸€ 2~10ì ë˜ëŠ” ì˜ë¬¸ 2~20ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.
                </p>
              </div>

              <div>
                <label
                    class="text-base md:text-lg text-title dark:text-white leading-none mb-2 sm:mb-3 block">ì´ë©”ì¼</label>
                <input
                    ref="emailRef"
                    v-model="form.email"
                    class="w-full h-12 md:h-14 bg-white dark:bg-dark-secondary border border-[#E3E5E6] text-title dark:text-white focus:border-primary p-4 outline-none duration-300"
                    type="text"
                    placeholder="ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                />
                <p v-if="form.email && !isValidEmail" class="text-sm text-red-500 mt-1">
                  ìœ íš¨í•œ ì´ë©”ì¼ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤. ì˜ˆ: example@domain.com
                </p>
              </div>

              <div>
                <label
                    class="text-base md:text-lg text-title dark:text-white leading-none mb-2 sm:mb-3 block">ì „í™”ë²ˆí˜¸</label>
                <input
                    ref="phoneRef"
                    v-model="form.phone"
                    class="w-full h-12 md:h-14 bg-white dark:bg-dark-secondary border border-[#E3E5E6] text-title dark:text-white focus:border-primary p-4 outline-none duration-300"
                    type="text"
                    placeholder="ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                />
                <p v-if="form.phone && !isValidPhone" class="text-sm text-red-500 mt-1">
                  010 / 070 / 02~064 ì§€ì—­ë²ˆí˜¸ë§Œ í—ˆìš©ë©ë‹ˆë‹¤.
                </p>
              </div>
            </div>

            <!--            -->
            <!-- â”€â”€ ìš°í¸ë²ˆí˜¸ / ê¸°ë³¸ì£¼ì†Œ / ìƒì„¸ì£¼ì†Œ â”€â”€ -->
            <div class="grid gap-5 md:gap-6 mt-5">
              <!-- ìš°í¸ë²ˆí˜¸ ê²€ìƒ‰ ë²„íŠ¼ + ê²°ê³¼ í‘œì‹œ -->
              <div>
                <label
                    class="text-base md:text-lg text-title dark:text-white leading-none mb-2 sm:mb-3 block">ìš°í¸ë²ˆí˜¸</label>
                <div class="flex">
                  <input
                      v-model="postalCode"
                      readonly
                      class="flex-1 h-12 md:h-14 bg-white dark:bg-dark-secondary border border-[#E3E5E6] text-title dark:text-white focus:border-primary p-4 outline-none duration-300"
                      placeholder="ìš°í¸ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”"
                  />
                  <button  ref="postcodeButtonRef" @click="openPostcode" class="ml-2 bg-primary text-white px-4 md:px-6 rounded-md">
                    ìš°í¸ë²ˆí˜¸ ì°¾ê¸°
                  </button>
                </div>
              </div>

              <!-- ê¸°ë³¸ì£¼ì†Œ í‘œì‹œ (readonly) -->
              <div>
                <label class="text-base md:text-lg text-title dark:text-white leading-none mb-2 sm:mb-3 block">ê¸°ë³¸ì£¼ì†Œ</label>
                <input
                    v-model="basicAddress"
                    readonly
                    class="w-full h-12 md:h-14 bg-white dark:bg-dark-secondary border border-[#E3E5E6] text-title dark:text-white focus:border-primary p-4 outline-none duration-300"
                    placeholder="ê¸°ë³¸ì£¼ì†Œê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤"
                />
              </div>

              <!-- ìƒì„¸ì£¼ì†Œ ì§ì ‘ ì…ë ¥ -->
              <div>
                <label
                    class="text-base md:text-lg text-title dark:text-white leading-none mb-2 sm:mb-3 block"
                >ìƒì„¸ì£¼ì†Œ</label
                >
                <input
                    id="detail-address-input"
                    v-model="form.detailAddress"
                    class="w-full h-12 md:h-14 bg-white dark:bg-dark-secondary border border-[#E3E5E6] text-title dark:text-white focus:border-primary p-4 outline-none duration-300"
                    type="text"
                    placeholder="ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ì•„íŒŒíŠ¸, ë™/í˜¸ìˆ˜ ë“±)"
                />
              </div>
            </div>

            <div class="mt-5">
              <label class="text-base md:text-lg text-title dark:text-white leading-none mb-2 sm:mb-3 block">ë°°ì†¡ ìš”ì²­ì‚¬í•­</label>
              <textarea
                  v-model="form.note"
                  class="w-full h-[120px] bg-white dark:bg-dark-secondary border border-[#E3E5E6] text-title dark:text-white focus:border-primary p-4 outline-none duration-300"
                  name="Message"
                  placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
              ></textarea>
            </div>
            <div class="mt-4 flex items-center">
              <input
                  id="default-address-checkbox"
                  type="checkbox"
                  v-model="isDefaultAddress"
                  class="w-4 h-4 text-primary bg-white border border-[#E3E5E6] rounded focus:ring-primary focus:ring-2"
              />
              <label for="default-address-checkbox" class="ml-2 text-base text-title dark:text-white">
                ê¸°ë³¸ë°°ì†¡ì§€ë¡œ ì„¤ì •í•˜ê¸°
              </label>
            </div>
          </div>

          <div data-aos="fade-up" data-aos-delay="200">
            <div v-if="orderItem"
                 class="bg-[#FAFAFA] dark:bg-dark-secondary pt-[30px] md:pt-[40px] lg:pt-[50px] px-[30px] md:px-[40px] lg:px-[50px] pb-[30px] border border-[#17243026] border-opacity-15 rounded-xl">
              <h4 class="font-semibold leading-none text-xl md:text-2xl mb-6 md:mb-10">
                ìƒí’ˆ ì •ë³´
              </h4>
              <div class="grid gap-5 mg:gap-6">
                <div class="flex items-center justify-between gap-5">
                  <div class="flex items-center gap-3 md:gap-4 lg:gap-6 cart-product flex-wrap">
                    <div class="w-16 sm:w-[70px] flex-none">
                      <img :src="orderItem.productImage" alt="product" />
                    </div>
                    <div class="flex-1">
                      <h5 class="font-semibold leading-none mt-2">
                        <router-link to="#">{{ orderItem.productName }}</router-link>
                      </h5>
                      <br>
                      <h6 class="leading-none font-medium">{{orderItem.categoryName}}</h6>
                    </div>
                  </div>
                  <h6 class="leading-none">{{ orderItem.price.toLocaleString() }} ì›</h6>
                  <h6 class="leading-none text-sm text-gray-500 mt-1">
                  </h6>
                </div>
              </div>
              <div
                  class="mt-6 pt-6 border-t border-bdr-clr dark:border-bdr-clr-drk text-right flex justify-end flex-col w-full ml-auto mr-0">
                <div
                    class="flex justify-between flex-wrap text-base sm:text-lg text-title dark:text-white font-medium mt-3">
                  <span>ìˆ˜ëŸ‰:</span>
                  <span>{{ orderItem.quantity }} ê°œ</span>
                </div>
                <div
                    class="flex justify-between flex-wrap text-base sm:text-lg text-title dark:text-white font-medium mt-3">
                  <span>ë°°ì†¡ë¹„:</span>
                  <span> {{ deliveryFee.toLocaleString() }} ì›</span>
                </div>
                <div
                    class="flex justify-between flex-wrap text-base sm:text-lg text-title dark:text-white font-medium mt-3">
                  <span>ì´ í• ì¸ ê¸ˆì•¡:</span>
                  <span>0 ì›</span>
                </div>
                <div class="flex justify-between flex-wrap text-base sm:text-lg text-title dark:text-white font-medium">
                  <span>ì´ ì£¼ë¬¸ ê¸ˆì•¡:</span>
                  <span>{{ totalPrice.toLocaleString() }} ì›</span>
                </div>

              </div>
              <div class="mt-6 pt-6 border-t border-bdr-clr dark:border-bdr-clr-drk">
                <div class="flex justify-between flex-wrap font-semibold leading-none text-2xl md:text-3xl">
                  <span>ì´ ê²°ì œ ê¸ˆì•¡:</span>
                  <span>{{ totalAmount.toLocaleString() }} ì› </span>
                </div>
              </div>
            </div>
            <div v-else class="text-center text-gray-500 mt-10">
              <p>ğŸ›’ ì£¼ë¬¸í•  ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
            <div class="mt-7 md:mt-12">
              <!--              <h4 class="font-semibold leading-none text-xl md:text-2xl mb-6 md:mb-10">ê²°ì œ ë°©ë²•</h4>-->
              <div class="wrapper">
                <div class="box_section">
                  <!-- ê²°ì œ UI -->
                  <div id="payment-method"></div>
                  <!-- ì´ìš©ì•½ê´€ UI -->
                  <div id="agreement"></div>
                </div>
              </div>
              <div class="mt-4 md:mt-6 flex flex-wrap gap-3">
                <router-link to="#" class="btn btn-outline" data-text="ì¥ë°”êµ¬ë‹ˆë¡œ ëŒì•„ê°€ê¸°"><span>ì¥ë°”êµ¬ë‹ˆë¡œ ëŒì•„ê°€ê¸°</span></router-link>
                <button
                    :disabled="!ready"
                    @click="handleSubmit"
                    class="btn btn-theme-solid"
                    data-text="ê²°ì œí•˜ê¸°">
                  <span>ê²°ì œí•˜ê¸°</span>
                </button>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <FooterThree/>
    <ScrollToTop/>
  </div>
</template>

<script setup>
import { useOrderStore } from '@/modules/order/stores/order'
import {computed, ref, reactive, watch, onMounted} from "vue";
import { loadTossPayments } from "@tosspayments/tosspayments-sdk";
import NavbarOne from '@/components/navbar/navbar-one.vue';
import FooterThree from '@/components/footer/footer-three.vue';
import ScrollToTop from '@/components/scroll-to-top.vue';
import 'swiper/swiper-bundle.css';
import Aos from 'aos';
import 'aos/dist/aos.css';
import bg from "@/assets/img/shortcode/breadcumb.jpg";
import  {prepareOrder} from "@/modules/order/services/orderApi";
import {cancelPayment} from "@/modules/payment/services/payment";


function generateRandomString() {
  return window.btoa(Math.random().toString()).slice(0, 20);
}

const orderStore = useOrderStore()

const orderItem = computed(() => orderStore.orderItem)
const totalPrice = computed(() => {
  return orderItem.value.price * orderItem.value.quantity;
})
const totalAmount = computed(() => {
  return totalPrice.value + deliveryFee.value;
})

const deliveryFee = computed(() => totalPrice.value >= 50000 ? 0 : 3000)

const nameRegex = /^([ê°€-í£]{2,10}|[a-zA-Z\s]{2,20})$/
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/
const phoneRegex = /^(010|070|0(2|3[1-3]|4[1-4]|5[1-5]|6[1-4]))\d{7,8}$/

const isValidName = computed(() => nameRegex.test(form.name))
const isValidEmail = computed(() => emailRegex.test(form.email))
const isValidPhone = computed(() => phoneRegex.test(form.phone.replace(/-/g, '')))

// â”€â”€â”€ 1. â€˜ë°°ì†¡ì§€â€™ í¼ ë°ì´í„° (reactive ê°ì²´) â”€â”€â”€
const form = reactive({
  name: "",
  email: "",
  phone: "",
  detailAddress: "",
  note: "",
});

const nameRef = ref(null)
const emailRef = ref(null)
const phoneRef = ref(null)
const postcodeButtonRef = ref(null)

const postalCode = ref("");
const basicAddress = ref("");

// â€œê¸°ë³¸ë°°ì†¡ì§€ë¡œ ì„¤ì •â€ ì—¬ë¶€
const isDefaultAddress = ref(false);

const handleSubmit = () => {
  if (!nameRegex.test(form.name)) {
    alert('ìœ íš¨í•œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”')
    return
  }
  if (!emailRegex.test(form.email)) {
    alert('ìœ íš¨í•œ ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”')
    return
  }
  if (!phoneRegex.test(String(form.phone).replace(/-/g, ''))) {
    alert('ìœ íš¨í•œ ì „í™”ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”')
    return
  }
  if (!postalCode.value || !basicAddress.value) {
    alert('ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. "ìš°í¸ë²ˆí˜¸ ì°¾ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”.')
    return
  }
  if(!form.detailAddress) {
    alert('ìƒì„¸ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”')
    return
  }

  requestPayment();


}

function openPostcode() {
  // window.daum.Postcode ê°ì²´ê°€ ë¡œë“œë˜ì–´ ìˆì–´ì•¼ í•¨
  new window.daum.Postcode({
    oncomplete(data) {
      // data.zonecode: 5ìë¦¬ ìš°í¸ë²ˆí˜¸
      // data.address: ê¸°ë³¸ì£¼ì†Œ (ë„ë¡œëª… ë˜ëŠ” ì§€ë²ˆ)
      postalCode.value = data.zonecode;
      basicAddress.value = data.address;

      // ìƒì„¸ì£¼ì†Œ ì…ë ¥ì¹¸ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
      const detailInput = document.getElementById("detail-address-input");
      if (detailInput) {
        detailInput.focus();
      }
    }
  }).open();
}

// TODO: ê°œë°œìì„¼í„°ì—ì„œ ë°œê¸‰ë°›ì€ ê²°ì œ ìœ„ì ¯ ì—°ë™ìš© Client Keyë¡œ ë³€ê²½í•˜ì„¸ìš”.
const clientKey = "test_gck_docs_Ovk5rk1EwkEbP0W43n07xlzm";
// TODO: ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„œëŠ” ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ê³ ìœ  ID(ì˜ˆ: userId) ë“±ì„ ë„£ì–´ì•¼ í•©ë‹ˆë‹¤.
const customerKey = generateRandomString();

// â”€â”€â”€ ë°˜ì‘í˜• ìƒíƒœ ì •ì˜ â”€â”€â”€
const ready = ref(false);
const widgets = ref(null);

// ê¸ˆì•¡, í†µí™” ì •ë³´
const amount = computed(() => ({
  currency: "KRW",
  value: totalAmount.value || 0,
}));

async function fetchPaymentWidgets() {
  try {
    // TossPayments SDK ì´ˆê¸°í™”
    const tossPayments = await loadTossPayments(clientKey);

    // â”€â”€â”€ íšŒì› ê²°ì œë¥¼ ìœ„í•œ ìœ„ì ¯ ìƒì„± (ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì˜ ì‹ë³„í‚¤ì¸ customerKey ì‚¬ìš©) â”€â”€â”€
    widgets.value = tossPayments.widgets({ customerKey });

    // â”€â”€â”€ ë¹„íšŒì› ê²°ì œë¥¼ ì›í•˜ì‹¤ ê²½ìš° ì•„ë˜ì²˜ëŸ¼ ë³€ê²½í•˜ì—¬ ì‚¬ìš©í•˜ì„¸ìš”. â”€â”€â”€
    // widgets.value = tossPayments.widgets({ customerKey: ANONYMOUS });
  } catch (error) {
    console.error("Error fetching payment widget:", error);
  }
}

async function renderPaymentWidgets() {
  if (!widgets.value) return;

  try {
    // 1) ìœ„ì ¯ì— ì£¼ë¬¸ ê¸ˆì•¡ ì„¸íŒ… (renderPaymentMethods, renderAgreement í˜¸ì¶œ ì „ì— ë°˜ë“œì‹œ ì„¤ì •í•´ì•¼ í•¨)
    await widgets.value.setAmount(amount.value);

    // 2) ê²°ì œ UIì™€ ì•½ê´€ UI ë™ì‹œ ë Œë”ë§
    await Promise.all([
      // â”€â”€â”€ ê²°ì œ ìˆ˜ë‹¨ UI ë Œë”ë§ â”€â”€â”€
      widgets.value.renderPaymentMethods({
        selector: "#payment-method", // templateì˜ <div id="payment-method">ì™€ ì¼ì¹˜í•´ì•¼ í•¨
        variantKey: "DEFAULT",
      }),
      // â”€â”€â”€ ì´ìš©ì•½ê´€ UI ë Œë”ë§ â”€â”€â”€
      widgets.value.renderAgreement({
        selector: "#agreement",      // templateì˜ <div id="agreement">ì™€ ì¼ì¹˜í•´ì•¼ í•¨
        variantKey: "AGREEMENT",
      }),
    ]);

    ready.value = true;
  } catch (error) {
    console.error("Error rendering payment widgets:", error);
  }
}

async function requestPayment() {
  if (!widgets.value || !ready.value) {
    alert("ì‹œìŠ¤í…œì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.");
    return;
  }

  if (!orderItem.value || totalAmount.value <= 0) {
    alert("ê²°ì œ ê¸ˆì•¡ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    return;
  }


  if(orderItem.value.stockCount <= 0){
    alert('í•´ë‹¹ ì œí’ˆì˜ ì¬ê³  ìˆ˜ëŸ‰ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!');
    return;
  }

  let orderId = ''

  try {
    const payload = {
      userId: 1, //ì¶”í›„ ë³¸ì¸ ì•„ì´ë””ë¡œ ë³€ê²½í•„ìš”.
      orderItems: [
        {
          productId: orderItem.value.productId,
          quantity: orderItem.value.quantity,
        }
      ],
      shippingRequest: form.note,
      postalCode: postalCode.value,
      basicAddress: basicAddress.value,
      detailedAddress: form.detailAddress
    };


    const res = await prepareOrder(payload);
    const { orderName, customerName } = res.data;
    orderId = res.data.orderId;

    await widgets.value.requestPayment({
      orderId,
      orderName,
      customerName,
      successUrl: `${window.location.origin}/payment-success`,
      failUrl: `${window.location.origin}/payment-failure`
    });

  } catch (error) {
    if (error.code === 'USER_CANCEL') {
      await cancelPayment(orderId);
      alert('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
    } else {
      console.error("Error requesting payment:", error);
    }
  }
}

onMounted(() => {
  Aos.init();
  if (!orderStore.orderItem) {
    const saved = sessionStorage.getItem('orderItem')
    if (saved) {
      orderStore.setOrderItem(JSON.parse(saved))
    }
  }
});



// ì»´í¬ë„ŒíŠ¸ ë§ˆìš´íŠ¸ ì‹œ ê²°ì œ ìœ„ì ¯ ì´ˆê¸°í™” & ë Œë”ë§
onMounted(async () => {
  await fetchPaymentWidgets();
  await renderPaymentWidgets();
});


watch(isDefaultAddress, (newVal) => {
  console.log("ê¸°ë³¸ë°°ì†¡ì§€ ì„¤ì • ì—¬ë¶€:", newVal);
  // ì‹¤ì œë¡œëŠ” ì´ ì‹œì ì— ì„œë²„ API í˜¸ì¶œ â†’ í¼ ë°ì´í„°(form + newVal) ì „ì†¡
});

</script>
